<elem-leaf>
  <div>

    <div if={leaf} class="p-l:10px dp:ib">

      <a class="fu-trash fs:70pc m-b:4px dp:ib c:grey300" onclick={handleDelete} />

      <elem-text
        class="fw:500 p:2px-5px fc-bg:white ps:rl dp:ib mnw:100px"
        text={leaf.value}
        placeholder={opts.fieldPlaceholder}
        on-edit={opts.onEdit}
        cb-extras={opts.cbExtras || leaf.id}
        autofocus={opts.autofocus} />

        <a if={!childIsValue && !ghostLeaf && leaf.id !== 'ghost' } class="fu-plus fs:70pc p:5px c:white bg:grey300 m-b:4px" onclick={handleAddFieldGhost} />

        <a if={leaf.type === 'field' && !childIsValue && leaf.id !== 'ghost' && !noChildren} class="fu-chevron-small-down p:5px c:grey fs:70pc m-b:4px" />
        <a if={childIsValue || ghostLeaf && ghostLeaf.type === 'value'} class="fu-chevron-small-right p:5px c:grey fs:70pc m-b:4px" />
        
        <a if={ noChildren && leaf.id !== 'ghost' && !ghostLeaf } class="fu-text_fields fs:70pc p:5px c:white bg:grey300 m-b:4px" onclick={handleAddValueGhost} />
        <a if={ noChildren && leaf.id !== 'ghost' && !ghostLeaf } class="fu-camera fs:70pc p:5px c:white bg:grey300 m-b:4px" onclick={handleAddValueGhost} />

        <elem-text
          class="dp:ib va:t p:2px-5px fc-bg:white"
          if={ghostLeaf && ghostLeaf.type === 'value'}
          autofocus={true}
          placeholder="value"
          cb-extras={ghostLeaf}
          on-edit={parent.opts.onCreate} />

        <a if={ghostLeaf && ghostLeaf.type === 'value'} class="fu-trash fs:70pc m-b:4px dp:ib c:grey300" onclick={handleDeleteGhost} />

        <elem-text
          if={childIsValue}
          class="dp:ib va:t p:2px-5px fc-bg:white"
          text={child && child.value}
          placeholder={opts.valuePlaceholder}
          on-edit={opts.onEdit}
          cb-extras={child && child.id} />
    </div>

    <div class="p-l:25px bd-l:1px-ds-grey200" if={!childIsValue}>
      <elem-leaf
        if={ghostLeaf && ghostLeaf.type === 'field'}
        leaf={ghostLeaf}
        poinject={parent.opts.poinject}
        autofocus={true}
        field-placeholder="field"
        value-placeholder="value"
        cb-extras={ghostLeaf}
        on-edit={parent.opts.onCreate}
        on-delete={parent.opts.onDelete} />

      <elem-leaf each={leaf in child} leaf={leaf} poinject={parent.opts.poinject} on-edit={parent.opts.onEdit} on-create={parent.opts.onCreate} on-delete={parent.opts.onDelete} />
    </div>
  </div>

  <script>
    const self = Object.assign(this, {
      leaf: opts.leaf,
      childIsValue: null,
      noChildren: null,
      child: null,
      ghostLeaf: null,
    });

    self.handleAddGhost = (type = 'field') => {
      let ghostLeaf = {
        parent: self.leaf && self.leaf.id,
        type: type,
        value: '',
        id: 'ghost',
      };
      self.update({ ghostLeaf });
    }

    self.handleAddFieldGhost = (e) => self.handleAddGhost();
    self.handleAddValueGhost = (e) => self.handleAddGhost('value');

    self.handleDelete = () => opts.onDelete(self.leaf.id);
    self.handleDeleteGhost = () => self.update({ ghostLeaf: null })

    self.setChild = () => {

      let child = self.leaf
        ? self.opts.poinject.filter(leaf => leaf.parent === self.leaf.id)
        : opts.poinject.filter(leaf => !leaf.parent);

      if(child.length > 1){ self.child = child; return; }
      if(child.length === 1 && child[0].type === 'field'){
        self.child = child;
        return;
      }

      if(!child.length){
        self.noChildren = true;
        return;
      }

      self.child = child.shift();
      self.childIsValue = self.leaf.id !== 'ghost' && self.child;
    }

    self.setChild();
    this.on('update', () => self.setChild());

  </script>

</elem-leaf>
