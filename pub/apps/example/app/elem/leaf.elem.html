<elem-leaf>
  <div>
    <div class="p-l:10px dp:ib">

      <a if={leaf} class="fu-trash fs:70pc m-b:4px dp:ib c:grey300" onclick={leaf.id === 'ghost' && handleDeleteGhost || handleDelete} />

      <elem-text
        if={leaf}
        class="fw:500 p:2px-5px fc-bg:white ps:rl dp:ib mnw:60px"
        text={leaf.value}
        placeholder="new field"
        on-edit={handleEditField}
        cb-extras={opts.cbExtras || leaf.id}
        autofocus={opts.autofocus} />

        <a if={leaf && !childIsValue && !ghostLeaf && leaf.id !== 'ghost'} class="fu-plus fs:70pc p:5px c:white bg:grey300 m-b:4px" onclick={handleAddFieldGhost} />

        <a if={leaf && leaf.type === 'field' && !childIsValue && leaf.id !== 'ghost' && !noChildren} class="fu-chevron-small-down p:5px c:grey fs:70pc m-b:4px" />
        <a if={childIsValue || ghostLeaf && ghostLeaf.type === 'value'} class="fu-chevron-small-right p:5px c:grey fs:70pc m-b:4px" />

        <span if={ noChildren && leaf.id !== 'ghost' && !ghostLeaf }>
          <a class="fu-text_fields fs:70pc p:5px c:white bg:grey300 m-b:4px dp:ib m-t:2px" onclick={handleAddValueGhost} />

          <input id="image" class="op:0 ps:ab w,h:0 dp:n" type="file" name="files" onchange={handleImageUpload} />
          <label for="image" class="fu-camera fs:70pc p:5px c:white bg:grey300 dp:ib m-b:6px" />
        </span>

        <elem-text
          class="dp:ib va:t p:2px-5px fc-bg:white"
          if={ghostLeaf && ghostLeaf.type === 'value'}
          autofocus={true}
          placeholder="value"
          cb-extras={ghostLeaf}
          on-edit={parent.opts.onCreate} />

        <elem-text
          if={childIsValue && !childIsImage}
          class="dp:ib va:t p:2px-5px fc-bg:white"
          text={child && child.value}
          placeholder={opts.valuePlaceholder}
          on-edit={opts.onEdit}
          cb-extras={child && child.id} />

        <span if={childIsImage} class="w:175px fux-boxsh bd:3px-sd-white m-b:5px">
          <img class="dp:bk w:100pc" src={child.value} />
        </span>

        <a if={ghostLeaf && ghostLeaf.type === 'value' || childIsValue}
          class="fu-trash fs:70pc m-b:4px dp:ib c:grey300"
          onclick={childIsValue && handleDeleteValue || handleDeleteGhost} />

    </div>

    <div class="p-l:25px bd-l:1px-ds-grey200" if={!childIsValue}>
      <a if={!leaf} class="fu-plus fs:70pc p:5px c:white bg:grey300 m-b:4px m-l:5px" onclick={handleAddFieldGhost} />
      <elem-leaf
        if={ghostLeaf && ghostLeaf.type === 'field'}
        leaf={ghostLeaf}
        poinject={opts.poinject}
        autofocus={true}
        cb-extras={ghostLeaf}
        on-edit={opts.onCreate}
        on-delete={opts.onDelete} />

      <elem-leaf
        each={leaf in child}
        leaf={leaf}
        mode-edit={parent.opts.modeEdit}
        poinject={parent.opts.poinject}
        on-edit={parent.opts.onEdit}
        on-create={parent.opts.onCreate}
        on-delete={parent.opts.onDelete}
        on-upload={parent.opts.onUpload} />
    </div>
  </div>

  <script>
    const self = Object.assign(this, {
      leaf: opts.leaf,
      childIsValue: null,
      childIsImage: null,
      noChildren: null,
      child: null,
      ghostLeaf: null,
    });

    self.handleAddGhost = (type = 'field') => {
      let ghostLeaf = {
        parent: self.leaf && self.leaf.id,
        type: type,
        value: '',
        id: 'ghost',
      };
      self.update({ ghostLeaf });
    }

    self.handleAddFieldGhost = (e) => self.handleAddGhost();
    self.handleAddValueGhost = (e) => self.handleAddGhost('value');

    self.handleDelete = () => opts.onDelete(self.leaf.id);
    self.handleDeleteGhost = () => {
      if(self.leaf.id === 'ghost')
        return self.parent.update({ ghostLeaf: null });

      self.update({ ghostLeaf: null });
    }
    self.handleDeleteValue = () => opts.onDelete(self.child.id);

    self.handleEditField = (value, leaf) =>
      self.opts.onEdit(value, leaf, self.handleDeleteGhost);

    self.handleImageUpload = (e) => {
      self.opts.onUpload(e.target.files, self.leaf.id);
      e.target.value = '';
    }

    self.setChild = () => {

      let child = self.leaf
        ? self.opts.poinject.filter(leaf => leaf.parent === self.leaf.id)
        : self.opts.poinject.filter(leaf => !leaf.parent);

      if(child.length > 1){ self.child = child; return; }
      if(child.length === 1 && child[0].type === 'field'){
        self.child = child;
        return;
      }

      if(!child.length){
        self.noChildren = true;
        return;
      }

      self.child = child.shift();
      self.childIsValue = self.leaf.id !== 'ghost' && self.child;
      self.childIsImage = self.child.value.indexOf('jpg') !== -1;
    }

    self.setChild();
    this.on('update', () => self.setChild());

  </script>

</elem-leaf>
