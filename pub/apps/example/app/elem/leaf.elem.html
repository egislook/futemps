<elem-leaf>
  <div class={'p-b:10px': !childIsValue}>

    <div if={leaf} class="p-l:12px dp:ib">
      <i if={leaf.type === 'field' && !childIsValue} class="fu-minus dp:ib fs:10px" />
      <elem-text
        class="fw:500 p:2px-5px dp:ib fc-bg:white"
        text={leaf.value}
        placeholder={opts.fieldPlaceholder}
        on-edit={opts.onEdit}
        cb-extras={leaf.id}
        autofocus={opts.autofocus} />
      <a if={!childIsValue} class="fu-plus fs:70pc p:5px dp:ib bg:grey700 c:white br:50pc" onclick={handleAddGhost} />
      <i if={childIsValue} class="fu-chevron-small-right op:0.2 m-b:3px" />
      <elem-text
        if={childIsValue}
        class="dp:ib va:t p:2px-10px fc-bg:white"
        text={child && child.value}
        placeholder={opts.valuePlaceholder}
        on-edit={opts.onEdit}
        cb-extras={child && child.id} />
    </div>

    <div class="p-l:30px" if={!childIsValue}>
      <elem-leaf field-placeholder="field" value-placeholder="value" if={ghostLeaf} leaf={ghostLeaf} poinject={parent.opts.poinject} autofocus={true} />
      <elem-leaf each={leaf in child} leaf={leaf} poinject={parent.opts.poinject} on-edit={parent.opts.onEdit} />
    </div>
  </div>

  <script>
    const self = Object.assign(this, {
      leaf: opts.leaf,
      childIsValue: null,
      child: null,
      ghostLeaf: null,
    });

    self.handleAddGhost = (e) => {
      console.log(self.leaf);
      self.update({
        ghostLeaf: {
          parent: self.leaf.id,
          type: 'field',
          value: '',
          id: 'ghost',
        }
      });
    }

    self.setChild = () => {

      let child = self.leaf
        ? self.opts.poinject.filter(leaf => leaf.parent === self.leaf.id)
        : opts.poinject.filter(leaf => !leaf.parent);

      if(child.length > 1){ self.child = child; return; }

      self.child = child.shift();
      self.childIsValue = true;
    }

    self.setChild();
    this.on('update', () => self.setChild());

  </script>

</elem-leaf>
