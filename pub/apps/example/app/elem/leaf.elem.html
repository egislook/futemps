<elem-leaf>
  <div>
    <div class="dp:ib" draggable={true}
      ondragstart={opts.onDragStart && opts.onDragStart.bind(e, leaf)}
      touchstart={opts.onDragStart && opts.onDragStart.bind(e, leaf)}
      ondragover={opts.onDragOver && opts.onDragOver.bind(e, leaf)}
      ondragleave={opts.onDragLeave}
      ondrop={opts.onDrop && opts.onDrop.bind(e, leaf)}>

      <a if={leaf && leaf.id === 'ghost'} class="fu-trash fs:70pc m-b:4px dp:ib c:grey300" onclick={leaf.id === 'ghost' && handleDeleteGhost} />

      <a if={leaf && leaf.id !== 'ghost' && (childIsValue || noChildren)} class="fu-grain fs:70pc m-b:4px dp:ib c:grey300 crs:move" />
      <a
        if={leaf && leaf.type === 'field' && !childIsValue && leaf.id !== 'ghost' && !noChildren}
        class="{'fu-chevron-small-down': isExtended, 'fu-chevron-small-right': !isExtended} c:grey fs:70pc m-b:4px"
        onclick={opts.onExtend.bind(null, { id: leaf.id })} />

      <elem-text
        if={leaf}
        class="fw:500 p:2px-5px-2px-0 fc-bg:white ps:rl dp:ib mnw:60px"
        text={leaf.value}
        placeholder="new field"
        on-edit={handleEditField}
        cb-extras={opts.cbExtras || leaf.id}
        autofocus={opts.autofocus} />


        <a if={leaf && !childIsValue && !ghostLeaf && leaf.id !== 'ghost'} class="fu-plus fs:70pc p:5px c:white bg:grey300 m-b:4px m-l:5npx ps:rl" onclick={handleAddFieldGhost}>
          <span if={leaf && !childIsValue && !isExtended && child && child.length} class="ps:ab fs:60pc bg:grey400 fw:500 p:2px-3px t,r:3npx br:3px">{child.length}</span>
        </a>

        <span if={ noChildren && leaf.id !== 'ghost' && !ghostLeaf }>
          <a class="fu-text_fields fs:70pc p:5px c:white bg:grey300 m-b:4px dp:ib m-t:2px" onclick={handleAddValueGhost} />

          <input id="image" class="op:0 ps:ab w,h:0 dp:n" type="file" name="files" onchange={handleImageUpload} />
          <label for="image" class="fu-camera fs:70pc p:5px c:white bg:grey300 dp:ib m-b:6px" />
        </span>

        <a if={childIsValue || ghostLeaf && ghostLeaf.type === 'value'}
          class="{'fu-chevron-small-down': valueIsExtended, 'fu-chevron-small-right': !valueIsExtended} p:5px m-l:5npx c:grey fs:70pc m-b:4px"
          onclick={valueIsExtendable && opts.onExtend.bind(null, { id: child.id })} />

        <elem-text
          class="dp:ib va:t p:2px-5px-2px-0 fc-bg:white"
          if={ghostLeaf && ghostLeaf.type === 'value'}
          autofocus={true}
          placeholder="value"
          cb-extras={ghostLeaf}
          on-edit={parent.opts.onCreate} />

        <elem-text2
          if={childIsValue && !childIsImage}
          class="dp:ib va:t mxh:100px of:auto"
          placeholder={opts.valuePlaceholder}
          truncate-from={valueIsExtendable && !valueIsExtended && truncateFrom}
          on-done={opts.onEdit}>
            <p data-id={parent.child && parent.child.id} class="p:2px-5px-2px-0 fc-p-l:5px">
              {parent.child && parent.child.value}
            </p>
        </elem-text2>

        <elem-text
          if={false && childIsValue && !childIsImage}
          class="dp:ib va:t p:2px-5px-2px-0 fc-bg:white"
          text={child && child.value}
          truncate-from={valueIsExtendable && !valueIsExtended && truncateFrom}
          placeholder={opts.valuePlaceholder}
          on-edit={opts.onEdit}
          cb-extras={child && child.id} />

        <span if={childIsImage} class="w:175px fux-boxsh bd:3px-sd-white m-tb:5px">
          <img class="dp:bk w:100pc" src={child.value} />
        </span>


        <a if={leaf && !ghostLeaf && leaf.id !== 'ghost'} class="fu-menu2 fs:70pc p:5px c:grey300 m-b:4px ps:rl {'bg:prim c:white-!': showMore}" onclick={handleMore} />
        <a if={ghostLeaf && ghostLeaf.type === 'value'} class="fu-trash fs:70pc m-b:4px dp:ib c:grey300" onclick={handleDeleteGhost} />

        <span if={showMore}>
          <a if={leaf && !childIsValue && !ghostLeaf && leaf.id !== 'ghost'} class="fu-stack-2 fs:70pc p:5px c:white bg:grey300 m-b:4px" onclick={handleDuplicate} />

          <a if={childIsValue} class="fu-trash fs:70pc m-b:4px dp:ib c:grey300 p:5px" onclick={childIsValue && handleDeleteValue} />

          <a if={leaf && (noChildren || !childIsValue)} class="fu-trash fs:70pc m-b:4px dp:ib p:5px c:grey300" onclick={leaf.id === 'ghost' && handleDeleteGhost || handleDelete} />

          <a if={leaf} class="fu-info fs:70pc p:5px c:grey300 m-b:4px ps:rl {'bg:black c:white-!': showInfo}" onclick={handleInfo}>
            <div if={showInfo} class="t:0 l:20px fux-boxsh ps:ab bg:prim p:10px z:5 c:white dp:tb dp:tr_div dp:tc_strong,span p-r:5px_strong">
              <div> <strong>ID: </strong> <span class="mnw:250px">{leaf.id}</span> </div>
              <div> <strong>PARENT: </strong> <span>{leaf.parent}</span> </div>
              <div> <strong>PATH: </strong> <span>{leaf.path}</span> </div>
              <div> <strong>ANCESTORS: </strong> <span>{JSON.stringify(leaf.ancestors, null, 2)}</span> </div>
            </div>
          </a>
        </span>

    </div>

    <div class="p-l:25px bd-l:1px-ds-grey200 m-l:5px" if={!childIsValue && isExtended}>
      <a if={!leaf} class="fu-plus fs:70pc p:5px c:white bg:grey300 m-b:4px m-l:5npx" onclick={handleAddFieldGhost} />
      <elem-leaf
        if={ghostLeaf && ghostLeaf.type === 'field'}
        leaf={ghostLeaf}
        poinject={opts.poinject}
        extended={opts.extended}
        extend-all={opts.extendAll}
        autofocus={true}
        cb-extras={ghostLeaf}
        on-edit={opts.onCreate}
        on-delete={opts.onDelete}
        on-duplicate={opts.onDuplicate}
        on-extend={opts.onExtend} />

      <elem-leaf
        each={leaf in child}
        leaf={leaf}
        mode-edit={parent.opts.modeEdit}
        poinject={parent.opts.poinject}
        extended={parent.opts.extended}
        extend-all={parent.opts.extendAll}
        on-edit={parent.opts.onEdit}
        on-create={parent.opts.onCreate}
        on-delete={parent.opts.onDelete}
        on-upload={parent.opts.onUpload}
        on-duplicate={parent.opts.onDuplicate}
        on-extend={parent.opts.onExtend}
        on-drag-start={parent.opts.onDragStart}
        on-drag-over={parent.opts.onDragOver}
        on-drag-leave={parent.opts.onDragLeave}
        on-drop={parent.opts.onDrop} />
    </div>
  </div>

  <script>
    const self = Object.assign(this, {
      leaf: opts.leaf,
      childIsValue: null,
      childIsImage: null,
      noChildren: null,
      child: null,
      ghostLeaf: null,
      showInfo: null,
      showMore: null,
      isExtended: null,
      valueIsExtended: null,
      valueIsExtendable: null,
      truncateFrom: 150,
      dragStarted: null,
      dragTimeout: null,
    });

    self.setExtended = () => {
      self.isExtended = self.opts.extendAll || !self.opts.leaf || self.opts.leaf && self.opts.extended.indexOf(self.opts.leaf.id) >= 0;
      self.valueIsExtendable = self.childIsValue && self.child.value.length > self.truncateFrom;
      self.valueIsExtended = self.childIsValue && self.valueIsExtendable && (self.opts.extendAll || self.opts.extended.indexOf(self.child.id) >= 0);
    }

    self.handleAddGhost = (type = 'field') => {
      let ghostLeaf = {
        parent: self.leaf && self.leaf.id,
        type: type,
        value: '',
        id: 'ghost',
      };


      self.leaf && self.opts.onExtend({ id: self.leaf.id, onlyOn: true });

      self.update({ ghostLeaf });
    }

    self.handleInfo = (e) => self.update({ showInfo: !self.showInfo });
    self.handleMore = (e) => self.update({ showMore: !self.showMore });

    self.handleAddFieldGhost = (e) => self.handleAddGhost();
    self.handleAddValueGhost = (e) => self.handleAddGhost('value');

    self.handleDelete = () => opts.onDelete(self.leaf.id);
    self.handleDeleteGhost = () => {
      if(self.leaf.id === 'ghost')
        return self.parent.update({ ghostLeaf: null });

      self.update({ ghostLeaf: null });
    }
    self.handleDeleteValue = () => opts.onDelete(self.child.id);

    self.handleEditField = (value, leaf) =>
      self.opts.onEdit(value, leaf, self.handleDeleteGhost);

    self.handleImageUpload = (e) => self.opts.onUpload(self.leaf.id, e);
    self.handleDuplicate = (e) => self.opts.onDuplicate(self.leaf.id);

    self.setChild = () => {

      let child = self.leaf
        ? self.opts.poinject.filter(leaf => leaf.parent === self.leaf.id)
        : self.opts.poinject.filter(leaf => !leaf.parent);

      if(child.length > 1){ self.child = child; return; }
      if(child.length === 1 && child[0].type === 'field'){
        self.child = child;
        return;
      }

      if(!child.length){
        self.noChildren = true;
        return;
      }

      self.child = child.shift();
      self.childIsValue = self.leaf.id !== 'ghost' && self.child;
      self.childIsImage = self.child.value.indexOf('jpg') !== -1;
    }

    self.setChild();
    self.setExtended();
    this.on('update', () => {
      self.setChild();
      self.setExtended();
    });

  </script>

</elem-leaf>
