<comp-adder>

  <i
    class="fs:130pc p:15px br:50pc ps:fx bs:2 ts:all z:10 r:2pc {
      'fu-feather bg:lg-prim400-prim600 c:white b:2pc': !_adderIsVisable,
      'fu-cross bg:white c:black b:90pc': _adderIsVisable
    }"
    onclick={_handleClick} />

  <div class="ps:fx t,l:0 w,h:100pc bg:blacka9 dp:flx jc:c ai:c ts:all z:9 {
    'tf:trl-200pc-skw-50dg z:0': !_adderIsVisable,
    'tf:trl-0-skw-0 z:9': _adderIsVisable,
  }">
    <div class="mxh,mxw:100pc w:100pc md-w:80pc bg:white br:2px bs:1 ts:all ta:l of:auto ps:rl">

      <div class="dp:flx ai:stc" each="{ fields, key in schema }">

        <div class="w:100pc p:5pc mxh:100pc bg:white600 bd-b-w:1px bd-c:grey200">
          <elem-form class="" fields={ _activeTabData } on-return-value={ handleReturnValue } />

          <div class="ta:r p-b:20px p:7px_button mnw:100px_button">
            <button class="bg:ts c:black200" onclick={_handleClick}>Cancel</button>
            <button class="bg:sec br:3px c:white bd-w:2px bd-c:sec bs:1" onclick={_handleSubmit}>Done</button>
          </div>
        </div>

        <div onclick={_toggleShowTabs} class="ps:rl mxw:300px mxh:100pc">
          <i class="md-dp:n fu-unread p:10px ps:ab r:1px t:40pc bg:white bs:1" />
          <div class="m:0 bs:2 bg:white of-x:hd of-y:auto ts:all mdx-ps:ab mdx-r,t:0 h:100pc {
            'mdx-w:1px': !_showTabs,
            'mdx-w:200px': _showTabs
          }">

            <div class="p:30px c:grey200 ta:c">
              <i class="fu-pencil2 fs:200pc p:10px" />
              <h3 class="mxh:40px">
                Edit or create schematic data
              </h3>
            </div>

            <a onclick={ _setActiveTab() }
              class="dp:bk p:10px-20px bd-b:1px-sld-grey200 ts:bg ws:np {
                'bg:prim c:white': !_getActiveTab(),
                'c:grey bg:ts': _getActiveTab()
              }">
              {key}
              <i class="fu-plus fs:70pc m-b:3px" />
            </a>

            <a each={ tab in parent.tabs }
              onclick={ _setActiveTab(tab) }
              class="dp:bk p:10px-20px bd-b:1px-sld-grey200 ts:bg ws:np {
                'bg:prim c:white': _getActiveTab(tab),
                'c:grey bg:ts': !_getActiveTab(tab)
              }">{tab}</a>
          </div>
        </div>


        <div if={false} class="p:20px bs:2 bg:white mxw:25pc bd-b-w:1px bd-c:grey200 of:hd">
          <div class="m:0 br:5px_a bd-c:prim_a bd-w:1px_a m:2px_a">

            <a onclick={ _setActiveTab() }
              class="p:10px-20px ts:bg {'bg:prim c:white': !_getActiveTab(), 'c:prim': _getActiveTab()}">
              {key}
              <i class="fu-plus fs:70pc m-b:3px" />
            </a>

            <a each={ tab in parent.tabs }
              onclick={ _setActiveTab(tab) }
              class="p:10px-20px ts:bg {'bg:prim c:white': _getActiveTab(tab), 'c:prim bg:ts': !_getActiveTab(tab)}">{tab}</a>

          </div>
        </div>

      </div>

    </div>
  </div>

  <script>
    this.mixin('tag');
    const tag = this;

    tag._adderIsVisable   = opts.visable;
    tag._activeTab        = null;
    tag._handleClick      = _handleClick;
    tag._handleSubmit     = _handleSubmit;
    tag._stopPropagation  = (e) => e.stopPropagation();
    tag._getActiveTab     = _getActiveTab;
    tag._setActiveTab     = _setActiveTab;
    tag._showTabs         = false;

    tag.handleCreateChunk = opts.handleCreateChunk;
    tag.schemaPath    = opts.schemaPath;
    tag.dataPath      = opts.dataPath;
    tag.getTree       = opts.getTree || ((path) => console.log('getTree', path));
    tag.getParentLeaf = opts.getParentLeaf;
    tag.schema        = opts.schema  || tag.getTree(tag.schemaPath) || { album: { title: { min: 2, max: 20, type: 'text' } } };
    tag.data          = opts.data    || tag.getTree(tag.dataPath);
    tag.dataLeaf      = tag.getParentLeaf(tag.dataPath);
    tag.schemaLeaf    = tag.getParentLeaf(tag.schemaPath);
    tag.tabs          = opts.tabs    || _getDataTabs(tag.data) || [];

    tag._activeTabData     = _getTabData(tag._activeTab);
    tag._toggleShowTabs    = (e) => { e.preventUpdate = true; tag.update({ _showTabs: !tag._showTabs}); };
    tag.handleReturnValue  = handleReturnValue;

    tag.on('update', (data) => {
      if(!data){
        tag.data          = tag.getTree(tag.dataPath);
        tag.tabs          = _getDataTabs(tag.data) || [];
      }
      console.log(data);
      console.log('update adder');
    });

    function handleReturnValue(value, extras, valid){
      if(!extras.path || extras.path && !_.get(tag._activeTabData, extras.path))
        return;

      _.set(tag._activeTabData, extras.path + '.value', value + '');
      _.set(tag._activeTabData, extras.path + '.valid', valid);

      console.log(tag._activeTabData);
      //tag._activeTabData[extras.name]['value'] = value;
      //console.log(tag._activeTabData);
      tag.update({ _innerUpdate: true });
    }

    function _getTabData(tabName){
      let headKey     = Object.keys(tag.schema).pop();
      let tempSchema  = JSON.parse(JSON.stringify(tag.schema[headKey]));

      if(!tabName)
        return tempSchema;

      let dataHeadKey = Object.keys(tag.data).pop();
      let tempData = JSON.parse(JSON.stringify(tag.data[dataHeadKey][tabName]));

      __setDeepValues(tempSchema, tempData);

      function __setDeepValues(_schema, _tabData){
        for(let key in _tabData){
          if(_tabData[key] && _schema[key]){
            if(typeof _tabData[key] === 'object')
              _schema[key] = __setDeepValues(_schema[key], _tabData[key]);
            if(typeof _tabData[key] === 'string'){
              _schema[key]['value'] = _tabData[key];
              _schema[key]['valid'] = true;
            }
          }
        }
        return _schema;
      }

      return tempSchema;
    }

    function _setActiveTab(tabName = null){
      return (e) => {
        let headKey = Object.keys(tag.data).pop();
        tag.update({
          _activeTab: tabName,
          _activeTabData: _getTabData(tabName)
        })
        e.preventDefault();
      }
    }

    function _getActiveTab(tabName){
      if(!tabName)
        return !!tag._activeTab;

      return tag._activeTab === tabName;
    }

    function _getDataTabs(data){
      if(typeof data !== 'object')
        return [];

      let headKey = Object.keys(data).pop();
      return Object.keys(data[headKey]);
    }

    function _handleSubmit(e){
      e.preventUpdate = true;

      //console.log(tag._activeTabData, tag.dataLeaf, tag.schemaLeaf);

      //console.log(tag._activeTabData, __schemeToData(tag._activeTabData));

      tag.handleCreateChunk(__schemeToData(tag._activeTabData), tag.schemaPath, (err, json) => {
        console.log(json);
      });

      function __schemeToData(schemeData){
        let obj = {};

        for(let key in schemeData){
          if(!schemeData[key].type)
            obj[key] = __schemeToData(schemeData[key]);
          else if(schemeData[key].value)
            obj[key] = schemeData[key].value;
        }
        return Object.keys(obj).length && obj;
      }

    }

    function _handleClick(e){
      e.preventUpdate = true;
      const method = tag._adderIsVisable ? 'remove' : 'add';
      document.body.classList[method]('fux-clear');
      //document.body.onmousewheel  = (e) => { tag._adderIsVisable && e.preventDefault() }
      //document.body.ontouchmove   = (e) => { tag._adderIsVisable && e.preventDefault() }
      tag.update({ _adderIsVisable: !tag._adderIsVisable })
    }

  </script>
</comp-adder>
